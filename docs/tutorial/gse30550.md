# Influenza A Bulk RNA-seq Data

There is a tutorial for the CRISGITime package using the GSE30550 dataset, which contains bulk RNA-seq data from patients infected with the H3N2 influenza virus. The dataset includes samples collected at different time points and clinical symptoms.

## Installation
```bash
pip install git+https://github.com/compbioclub/CRISGI.git@main
```

## Importing Required Libraries
```python
from CRISGI import CRISGITime
import pandas as pd
import anndata as ad
from scipy.sparse import csr_matrix
```

## Loading Data & Preprocessing
```python
adata = ad.read_h5ad('./data/GSE30550_raw.adata')
meta_data = pd.read_csv('./data/GSE30550_meta.csv',index_col=0)
print(csr_matrix(adata.varm['bg_net']).count_nonzero()/2)
del adata.varm['bg_net']
adata.layers['log1p'] = adata.X
adata.obs['symptom'] = adata.obs['clinic_pheno:ch1']
adata.obs['subject'] = adata.obs['person']
adata.obs['type'] = adata.obs['time'].apply(lambda x: 'Ref' if x == 'Baseline' else 'Test')
adata.obs['timepoint'] = adata.obs.time
adata.obs['time'] = adata.obs.timepoint.apply(lambda x: -24 if x == 'Baseline' else x.replace('Hour ', ' ')).astype(int)
adata.obs['test'] = adata.obs['subject'].astype(str) + ' ' + adata.obs['time'].astype(str)
adata.obs['clinical_symptoms'] = meta_data.loc[adata.obs.index, 'clinical_symptoms'].values
adata.write_h5ad('./data/GSE30550_H3N2.adata')
```

## Creating CRISGITIME Object
```python
interaction_methods = 'pos_coexp'
# Create CRISGITime object
crisgi_obj = CRISGITime(
    adata=adata,
    interaction_methods=interaction_methods,
    n_hvg=5000,
    organism="human",
    n_threads=1,
    dataset="GSE30550_H3N2",
    class_type="time",
    out_dir="./out",
)
```

## Reference and Perturbation Groups
```python
ref_obs = adata.obs[adata.obs.type == 'Ref'].index.to_list()
per_obss = [[x] for x in adata.obs.index.to_list()]
```

## Calculating Entropy
```python
groupby='symptom'
crisgi_obj.calculate_entropy(
    ref_obs=ref_obs,
    per_obss=per_obss,
    groupby=groupby,
    ref_time="Ref",
    layer="log1p",
)
```

## Setting DER/TER Parameters
```python
n_top_interactions = None
test_type = 'TER'
per_group = 'Symptomatic'
```

## Calulating DER and TER
```python
crisgi_obj.test_DER(
    groupby="symptom",
    target_group=per_group,
)
crisgi_obj.get_DER(
    target_group=per_group,
    n_top_interactions=n_top_interactions,
    p_adjust=True,
    p_cutoff=0.05,
    fc_cutoff=1,
    sortby="pvals_adj",
)
crisgi_obj.test_TER(per_group=per_group)
```

## DER/TER Results Output
```python
# Import required libraries
import crisgi.plotting_sniee_time as pl

# Plot general DER/TER results
pl.interaction_score_line(
    crisgi_obj,
    per_group=per_group,
    method=interaction_methods,
    test_type=test_type,
    unit_header=None,
)

# Generate interaction score matrix for each subject
pl.get_interaction_score(
    crisgi_obj,
    per_group=per_group,
    groupby="symptom",
    method=interaction_methods,
    test_type="TER",
    subject_header="subject",
    out_dir=None,
)

# Generate interaction score images
pl.generate_interaction_score_images(
    folder_path=crisgi_obj.out_dir,
    output_path=crisgi_obj.out_dir,
    rep_n=1,
    robust=True,
    scale=False,
)
```

## Startpoint Detection
```python
crisgi_obj.detect_startpoint(symptom_types = ["Symptomatic"])
print(crisgi_obj.edata.obs.CT_time)
```

## Training and Predicting with CRISGITime

```python
# Import required libraries
import torch
from torchvision import transforms
from torch.utils.data import DataLoader
from crisgi.util import ImageDataset

# Check if GPU is available and set device
crisgi_obj.device = "cuda" if torch.cuda.is_available() else "cpu"

# Set the model type and paths for the autoencoder and MLP models
transform = transforms.Compose([transforms.Resize((224, 224)), transforms.ToTensor()])
image_dir = os.path.join(crisgi_obj.out_dir, "images")
if not os.path.exists(image_dir):
    os.makedirs(image_dir)

pl.plot_interaction_score(
    crisgi_obj,
    output_path=image_dir,
    robust=True,
    scale=False,
    rep_n=2,
    label=True,
)

dataset = ImageDataset(
    image_dir=image_dir,
    label_csv=os.path.join(image_dir, "labels.csv"),
    transform=transform,
    return_label=True,
)

loader = DataLoader(dataset, batch_size=16, shuffle=True)

crisgi_obj.set_model_type(
    model_type="cnn",
    ae_path="./data/model/3L-CNN/GSE30550_H3N2_ae_model.pth",
    mlp_path="./data/model/3L-CNN/GSE30550_H3N2_mlp_model.pth",
    device=crisgi_obj.device,
)
# crisgi_obj.set_model_type(model_type='simple_cnn',device = crisgi_obj.device,)
# crisgi_obj.set_model_type(model_type='logistic',
#     model_path="CRISGI/data/model/logistic/GSE30550_H3N2_log_model.pth",
#     device = crisgi_obj.device,
# )

crisgi_obj.train(train_loader=loader, epochs=20)
predictions = crisgi_obj.predict(loader)
print(predictions)
```

## Enrichment Analysis

### Phenotype-level Accumulated Top n ORA
```python
crisgi_obj.n_threads = 1

# Will generate the enrich.csv in out_dir
crisgi_obj.pheno_level_accumulated_top_n_ORA(
    target_group=target_group,
    n_top_interactions=30,
    n_space=10,
    method=interaction_methods,
    test_type=test_type,
)

# Plot the phenotype-level accumulated top n ORA results
pl.pheno_level_accumulated_top_n_ORA(
    crisgi_obj,
    target_group=target_group,
    p_adjust=True,
    p_cutoff=0.05,
    n_top_interactions=30,
    method=interaction_methods,
    test_type=test_type,
)
```
### pheno_level_CT_rank
```python
ref_group = 'Asymptomatic'
target_group = 'Symptomatic'

crisgi_obj.pheno_level_CT_rank(
    ref_group=ref_group,
    target_group=target_group,
    n_top_interactions=30,
    sortby="pvals_adj",
    gene_sets=[
        "KEGG_2021_Human",
        "GO_Molecular_Function_2023",
        "GO_Cellular_Component_2023",
        "GO_Biological_Process_2023",
        "MSigDB_Hallmark_2020",
    ],
    prefix="test",
    min_size=5,
    max_size=1000,
    permutation_num=1000,
    seed=0,
)
```

### obs_level_CT_rank
```python
interactions = crisgi_obj.edata.uns[
    f"{interaction_methods}_{groupby}_{per_group}_{test_type}"
][0:n_top_interactions]
gene_sets = {f"{enrich_dataset} {test_type}{n_top_interactions}": interactions}

# Will generate the results in ./out_dir/prefix folder
crisgi_obj.obs_level_CT_rank(
    gene_sets=gene_sets,
    prefix="test",
    min_size=5,
)
```
